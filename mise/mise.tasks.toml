# =============================================================================
# Mise Tasks - Automation for Development Environment
# =============================================================================
# Docs: https://mise.jdx.dev/tasks/
# Symlink: ln -sf ~/.dotfiles/mise/mise.tasks.toml ~/.config/mise/mise.tasks.toml
# =============================================================================

# --- Setup Tasks ---

[tasks.setup]
description = "Full system setup"
depends = ["check-prereqs", "brew-install", "tools-install"]
run = "echo '✅ Setup complete!'"

[tasks.check-prereqs]
description = "Check prerequisites"
run = '''
#!/bin/bash
set -e
echo "Checking prerequisites..."
command -v brew >/dev/null || { echo "❌ Homebrew not installed"; exit 1; }
command -v git >/dev/null || { echo "❌ Git not installed"; exit 1; }
echo "✅ Prerequisites OK"
'''

[tasks.brew-install]
description = "Install Homebrew packages"
run = "brew bundle install --file=$HOME/.dotfiles/brew/Brewfile"

[tasks.tools-install]
description = "Install mise-managed tools"
run = "mise install"

# --- Validation Tasks ---

[tasks.check]
description = "Validate entire setup"
depends = ["check-tools", "check-paths", "check-env"]
run = "echo '✅ All checks passed!'"

[tasks.check-tools]
description = "Check tool versions"
run = '''
#!/bin/bash
echo "=== Tool Versions ==="
echo "Java:   $(java -version 2>&1 | head -1)"
echo "Ruby:   $(ruby --version 2>/dev/null || echo 'not installed')"
echo "Node:   $(node --version 2>/dev/null || echo 'not installed')"
echo "Python: $(python3 --version 2>/dev/null || echo 'not installed')"
echo "Mise:   $(mise --version 2>/dev/null || echo 'not installed')"
'''

[tasks.check-paths]
description = "Check for PATH duplicates"
run = '''
#!/bin/bash
echo "=== PATH Analysis ==="
echo "$PATH" | tr ':' '\n' | sort | uniq -c | sort -rn | head -20
DUPES=$(echo "$PATH" | tr ':' '\n' | sort | uniq -d)
if [[ -n "$DUPES" ]]; then
  echo ""
  echo "⚠️  WARNING: Duplicate paths found:"
  echo "$DUPES"
else
  echo ""
  echo "✅ No duplicate paths found."
fi
'''

[tasks.check-env]
description = "Check critical environment variables"
run = '''
#!/bin/bash
echo "=== Environment Variables ==="
echo "JAVA_HOME:     ${JAVA_HOME:-❌ NOT SET}"
echo "ANDROID_HOME:  ${ANDROID_HOME:-❌ NOT SET}"
echo ""
if [[ -n "$JAVA_HOME" ]]; then
  echo "✅ JAVA_HOME is set"
else
  echo "❌ JAVA_HOME is NOT set - Appium will fail!"
fi
if [[ -n "$ANDROID_HOME" && -d "$ANDROID_HOME" ]]; then
  echo "✅ ANDROID_HOME exists"
else
  echo "⚠️  ANDROID_HOME not found at: $ANDROID_HOME"
fi
'''

# --- Android Tasks ---

[tasks.android-check]
description = "Check Android SDK installation"
run = '''
#!/bin/bash
echo "=== Android SDK Status ==="
if [[ -d "$ANDROID_HOME" ]]; then
  echo "✅ Android SDK: $ANDROID_HOME"
  echo ""
  echo "Installed components:"
  ls -la "$ANDROID_HOME" 2>/dev/null | head -10
  echo ""
  adb --version 2>/dev/null || echo "⚠️  adb not in PATH"
else
  echo "❌ Android SDK: NOT FOUND at $ANDROID_HOME"
  exit 1
fi
'''

[tasks.android-avd-list]
description = "List Android Virtual Devices"
run = "avdmanager list avd"

# --- Appium Tasks ---

[tasks.appium-check]
description = "Check Appium installation and drivers"
run = '''
#!/bin/bash
echo "=== Appium Status ==="
appium --version || { echo "❌ Appium not installed"; exit 1; }
echo ""
echo "=== Installed Drivers ==="
appium driver list --installed
echo ""
echo "=== JAVA_HOME ==="
echo "$JAVA_HOME"
java -version 2>&1 | head -1
'''

[tasks.appium-doctor]
description = "Run Appium driver doctors"
run = '''
#!/bin/bash
echo "=== UIAutomator2 Doctor ==="
appium driver doctor uiautomator2 || true
echo ""
echo "=== XCUITest Doctor ==="
appium driver doctor xcuitest || true
'''

[tasks.appium-start]
description = "Start Appium server"
run = "appium --allow-insecure chromedriver_autodownload --allow-cors"

# --- Maintenance Tasks ---

[tasks.update]
description = "Update all tools"
depends = ["update-brew", "update-mise"]
run = "echo '✅ Updates complete!'"

[tasks.update-brew]
description = "Update Homebrew packages"
run = "brew update && brew upgrade"

[tasks.update-mise]
description = "Update mise and tools"
run = "mise self-update && mise upgrade"

[tasks.backup-brew]
description = "Backup Brewfile"
run = "brew bundle dump --force --file=$HOME/.dotfiles/brew/Brewfile && echo '✅ Brewfile updated'"

# --- Mobile Development Tasks ---

[tasks.mobile-check]
description = "Full mobile development environment check"
depends = ["check-env", "android-check", "appium-check"]
run = '''
#!/bin/bash
echo ""
echo "=== Mobile Development Environment ==="
echo "✅ All mobile development checks passed!"
echo ""
echo "Next steps:"
echo "  mise run appium-doctor  # Run full Appium diagnostics"
echo "  mise run appium-start   # Start Appium server"
'''
