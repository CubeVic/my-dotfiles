# =============================================================================
# Mise Configuration - Tool Version Management
# =============================================================================
# Docs: https://mise.jdx.dev/
# Symlink: ln -sf ~/.dotfiles/mise/config.toml ~/.config/mise/config.toml
# =============================================================================

[settings]
experimental = true
legacy_version_file = true
always_keep_install = true

[tools]
java = "21"
# ruby = "latest"  # Optional - install with: mise install ruby@latest

[env]
# =============================================================================
# JAVA CONFIGURATION (Required for Appium)
# =============================================================================
# JAVA_HOME is set dynamically in .zshrc after mise activation
# This avoids hardcoding version numbers that break on updates

# =============================================================================
# ANDROID SDK CONFIGURATION (Required for Appium)
# =============================================================================
# Core Android environment variable - most tools derive paths from this
ANDROID_HOME = "{{env.HOME}}/Library/Android/sdk"

# Derived paths - some tools expect these as environment variables
ANDROID_PLATFORM_TOOLS = "{{env.ANDROID_HOME}}/platform-tools"
ANDROID_EMULATOR = "{{env.ANDROID_HOME}}/emulator"
ANDROID_TOOLS = "{{env.ANDROID_HOME}}/tools"
ANDROID_TOOLS_BIN = "{{env.ANDROID_HOME}}/tools/bin"
ANDROID_CMDLINE_TOOLS = "{{env.ANDROID_HOME}}/cmdline-tools/latest/bin"

# Optional: bundletool for building APKs from AABs
BUNDLETOOL_PATH = "{{env.ANDROID_HOME}}/tools/bundletool.jar"

# =============================================================================
# TASKS
# =============================================================================

[tasks.check]
description = "Validate setup"
run = '''
echo "=== Tool Versions ==="
echo "Java:   $(java -version 2>&1 | head -1)"
echo "Mise:   $(mise --version)"
echo ""
echo "=== Environment ==="
echo "JAVA_HOME:    $JAVA_HOME"
echo "ANDROID_HOME: $ANDROID_HOME"
'''

[tasks.check-env]
description = "Check critical environment variables"
run = '''
echo "=== Environment Variables ==="
echo "JAVA_HOME:     ${JAVA_HOME:-NOT SET}"
echo "ANDROID_HOME:  ${ANDROID_HOME:-NOT SET}"
if [[ -n "$JAVA_HOME" ]]; then echo "✓ JAVA_HOME is set"; else echo "✗ JAVA_HOME missing"; fi
if [[ -n "$ANDROID_HOME" && -d "$ANDROID_HOME" ]]; then echo "✓ ANDROID_HOME exists"; else echo "✗ ANDROID_HOME missing"; fi
'''

[tasks.mobile-check]
description = "Full mobile development check"
run = '''
echo "=== Mobile Development Environment ==="
echo ""
echo "JAVA_HOME: $JAVA_HOME"
java -version 2>&1 | head -1
echo ""
echo "ANDROID_HOME: $ANDROID_HOME"
which adb 2>/dev/null && adb --version | head -1 || echo "adb not found"
echo ""
echo "Appium:"
appium --version 2>/dev/null || echo "appium not installed"
'''

[tasks.appium-doctor]
description = "Run Appium driver doctors"
run = '''
echo "=== UIAutomator2 Doctor ==="
appium driver doctor uiautomator2 || true
echo ""
echo "=== XCUITest Doctor ==="
appium driver doctor xcuitest || true
'''

# =============================================================================
# iOS TASKS
# =============================================================================

[tasks.ios-list]
description = "List available iOS simulators"
run = '''
echo "=== iOS Simulators ==="
xcrun simctl list devices
'''

[tasks.ios-runtimes]
description = "List installed iOS runtimes"
run = '''
echo "=== Installed Runtimes ==="
xcrun simctl list runtimes
'''

[tasks.ios-boot]
description = "Boot an iOS simulator"
usage = 'arg "<device>" help="Device name or UUID"'
run = '''
if [[ -z "${usage_device:-}" ]]; then
  echo "Usage: mise run ios-boot <device>"
  echo ""
  echo "Available devices:"
  xcrun simctl list devices available | grep -E "iPhone|iPad"
  exit 1
fi
echo "Booting $usage_device..."
xcrun simctl boot "$usage_device" 2>/dev/null || echo "Already booted or not found"
open -a Simulator
'''

[tasks.ios-shutdown]
description = "Shutdown all iOS simulators"
run = '''
echo "Shutting down all simulators..."
xcrun simctl shutdown all
echo "✓ Done"
'''

[tasks.ios-open]
description = "Open Simulator app"
run = "open -a Simulator"

[tasks.ios-install]
description = "Install app on booted simulator"
usage = 'arg "<app>" help="Path to .app file"'
run = '''
if [[ -z "${usage_app:-}" ]]; then
  echo "Usage: mise run ios-install <app>"
  exit 1
fi
echo "Installing $usage_app..."
xcrun simctl install booted "$usage_app"
echo "✓ Installed"
'''

[tasks.ios-check]
description = "Check iOS development environment"
run = '''
echo "=== iOS Development Environment ==="
echo ""
echo "Xcode:"
xcode-select -p
xcodebuild -version | head -2
echo ""
echo "Simulators:"
xcrun simctl list devices booted 2>/dev/null | grep -E "iPhone|iPad" || echo "No simulators running"
echo ""
echo "Appium XCUITest:"
appium driver list --installed 2>&1 | grep -i xcuitest || echo "xcuitest not installed"
'''

# =============================================================================
# ANDROID TASKS
# =============================================================================

[tasks.android-list]
description = "List Android emulators"
run = "emulator -list-avds"

[tasks.android-boot]
description = "Boot Android emulator"
usage = 'arg "<avd>" help="AVD name"'
run = '''
if [[ -z "${usage_avd:-}" ]]; then
  echo "Usage: mise run android-boot <avd>"
  echo ""
  echo "Available AVDs:"
  emulator -list-avds
  exit 1
fi
echo "Starting $usage_avd..."
emulator -avd "$usage_avd" &
'''

# =============================================================================
# APPIUM TASKS
# =============================================================================

[tasks.appium-start]
description = "Start Appium server"
run = "appium --allow-insecure chromedriver_autodownload --allow-cors"
