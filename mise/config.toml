# =============================================================================
# Mise Configuration - Tool Versions, Environment & Tasks
# =============================================================================
# Docs: https://mise.jdx.dev/
# Symlink: ln -sf ~/.dotfiles/mise/config.toml ~/.config/mise/config.toml
# =============================================================================

[settings]
experimental = true
legacy_version_file = true
always_keep_install = true

[tools]
java = "21"
# ruby = "latest"  # Optional - install with: mise install ruby@latest

[env]
# =============================================================================
# JAVA CONFIGURATION (Required for Appium)
# =============================================================================
# JAVA_HOME is set dynamically in .zshrc after mise activation
# This avoids hardcoding version numbers that break on updates

# =============================================================================
# ANDROID SDK CONFIGURATION (Required for Appium)
# =============================================================================
# Core Android environment variable - most tools derive paths from this
ANDROID_HOME = "{{env.HOME}}/Library/Android/sdk"

# Derived paths - some tools expect these as environment variables
ANDROID_PLATFORM_TOOLS = "{{env.ANDROID_HOME}}/platform-tools"
ANDROID_EMULATOR = "{{env.ANDROID_HOME}}/emulator"
ANDROID_TOOLS = "{{env.ANDROID_HOME}}/tools"
ANDROID_TOOLS_BIN = "{{env.ANDROID_HOME}}/tools/bin"
ANDROID_CMDLINE_TOOLS = "{{env.ANDROID_HOME}}/cmdline-tools/latest/bin"

# Optional: bundletool for building APKs from AABs
BUNDLETOOL_PATH = "{{env.ANDROID_HOME}}/tools/bundletool.jar"

# =============================================================================
# SETUP TASKS
# =============================================================================

[tasks.setup]
description = "Full system setup"
depends = ["check-prereqs", "brew-install", "tools-install"]
run = "echo '✅ Setup complete!'"

[tasks.check-prereqs]
description = "Check prerequisites"
run = '''
#!/bin/bash
set -e
echo "Checking prerequisites..."
command -v brew >/dev/null || { echo "❌ Homebrew not installed"; exit 1; }
command -v git >/dev/null || { echo "❌ Git not installed"; exit 1; }
echo "✅ Prerequisites OK"
'''

[tasks.brew-install]
description = "Install Homebrew packages"
run = "brew bundle install --file=$HOME/.dotfiles/brew/Brewfile"

[tasks.tools-install]
description = "Install mise-managed tools"
run = "mise install"

# =============================================================================
# VALIDATION TASKS
# =============================================================================

[tasks.check]
description = "Validate entire setup"
depends = ["check-tools", "check-paths", "check-env"]
run = "echo '✅ All checks passed!'"

[tasks.check-tools]
description = "Check tool versions"
run = '''
#!/bin/bash
echo "=== Tool Versions ==="
echo "Java:   $(java -version 2>&1 | head -1)"
echo "Ruby:   $(ruby --version 2>/dev/null || echo 'not installed')"
echo "Node:   $(node --version 2>/dev/null || echo 'not installed')"
echo "Python: $(python3 --version 2>/dev/null || echo 'not installed')"
echo "Mise:   $(mise --version 2>/dev/null || echo 'not installed')"
'''

[tasks.check-paths]
description = "Check for PATH duplicates"
run = '''
#!/bin/bash
echo "=== PATH Analysis ==="
echo "$PATH" | tr ':' '\n' | sort | uniq -c | sort -rn | head -20
DUPES=$(echo "$PATH" | tr ':' '\n' | sort | uniq -d)
if [[ -n "$DUPES" ]]; then
  echo ""
  echo "⚠️  WARNING: Duplicate paths found:"
  echo "$DUPES"
else
  echo ""
  echo "✅ No duplicate paths found."
fi
'''

[tasks.check-env]
description = "Check critical environment variables"
run = '''
#!/bin/bash
echo "=== Environment Variables ==="
echo "JAVA_HOME:     ${JAVA_HOME:-❌ NOT SET}"
echo "ANDROID_HOME:  ${ANDROID_HOME:-❌ NOT SET}"
echo ""
if [[ -n "$JAVA_HOME" ]]; then
  echo "✅ JAVA_HOME is set"
else
  echo "❌ JAVA_HOME is NOT set - Appium will fail!"
fi
if [[ -n "$ANDROID_HOME" && -d "$ANDROID_HOME" ]]; then
  echo "✅ ANDROID_HOME exists"
else
  echo "⚠️  ANDROID_HOME not found at: $ANDROID_HOME"
fi
'''

# =============================================================================
# iOS TASKS
# =============================================================================

[tasks.ios-list]
description = "List available iOS simulators"
run = '''
echo "=== iOS Simulators ==="
xcrun simctl list devices
'''

[tasks.ios-runtimes]
description = "List installed iOS runtimes"
run = '''
echo "=== Installed Runtimes ==="
xcrun simctl list runtimes
'''

[tasks.ios-boot]
description = "Boot an iOS simulator"
usage = 'arg "<device>" help="Device name or UUID"'
run = '''
if [[ -z "${usage_device:-}" ]]; then
  echo "Usage: mise run ios-boot <device>"
  echo ""
  echo "Available devices:"
  xcrun simctl list devices available | grep -E "iPhone|iPad"
  exit 1
fi
echo "Booting $usage_device..."
xcrun simctl boot "$usage_device" 2>/dev/null || echo "Already booted or not found"
open -a Simulator
'''

[tasks.ios-shutdown]
description = "Shutdown all iOS simulators"
run = '''
echo "Shutting down all simulators..."
xcrun simctl shutdown all
echo "✓ Done"
'''

[tasks.ios-open]
description = "Open Simulator app"
run = "open -a Simulator"

[tasks.ios-install]
description = "Install app on booted simulator"
usage = 'arg "<app>" help="Path to .app file"'
run = '''
if [[ -z "${usage_app:-}" ]]; then
  echo "Usage: mise run ios-install <app>"
  exit 1
fi
echo "Installing $usage_app..."
xcrun simctl install booted "$usage_app"
echo "✓ Installed"
'''

[tasks.ios-check]
description = "Check iOS development environment"
run = '''
echo "=== iOS Development Environment ==="
echo ""
echo "Xcode:"
xcode-select -p
xcodebuild -version | head -2
echo ""
echo "Simulators:"
xcrun simctl list devices booted 2>/dev/null | grep -E "iPhone|iPad" || echo "No simulators running"
echo ""
echo "Appium XCUITest:"
appium driver list --installed 2>&1 | grep -i xcuitest || echo "xcuitest not installed"
'''

# =============================================================================
# ANDROID TASKS
# =============================================================================

[tasks.android-list]
description = "List Android emulators"
run = "emulator -list-avds"

[tasks.android-boot]
description = "Boot Android emulator"
usage = 'arg "<avd>" help="AVD name"'
run = '''
if [[ -z "${usage_avd:-}" ]]; then
  echo "Usage: mise run android-boot <avd>"
  echo ""
  echo "Available AVDs:"
  emulator -list-avds
  exit 1
fi
echo "Starting $usage_avd..."
emulator -avd "$usage_avd" &
'''

[tasks.android-check]
description = "Check Android SDK installation"
run = '''
#!/bin/bash
echo "=== Android SDK Status ==="
if [[ -d "$ANDROID_HOME" ]]; then
  echo "✅ Android SDK: $ANDROID_HOME"
  echo ""
  echo "Installed components:"
  ls -la "$ANDROID_HOME" 2>/dev/null | head -10
  echo ""
  adb --version 2>/dev/null || echo "⚠️  adb not in PATH"
else
  echo "❌ Android SDK: NOT FOUND at $ANDROID_HOME"
  exit 1
fi
'''

[tasks.android-avd-list]
description = "List Android Virtual Devices"
run = "avdmanager list avd"

# =============================================================================
# APPIUM TASKS
# =============================================================================

[tasks.appium-check]
description = "Check Appium installation and drivers"
run = '''
#!/bin/bash
echo "=== Appium Status ==="
appium --version || { echo "❌ Appium not installed"; exit 1; }
echo ""
echo "=== Installed Drivers ==="
appium driver list --installed
echo ""
echo "=== JAVA_HOME ==="
echo "$JAVA_HOME"
java -version 2>&1 | head -1
'''

[tasks.appium-doctor]
description = "Run Appium driver doctors"
run = '''
#!/bin/bash
echo "=== UIAutomator2 Doctor ==="
appium driver doctor uiautomator2 || true
echo ""
echo "=== XCUITest Doctor ==="
appium driver doctor xcuitest || true
'''

[tasks.appium-start]
description = "Start Appium server"
run = "appium --allow-insecure chromedriver_autodownload --allow-cors"

# =============================================================================
# MOBILE DEVELOPMENT
# =============================================================================

[tasks.mobile-check]
description = "Full mobile development environment check"
depends = ["check-env", "android-check", "appium-check"]
run = '''
#!/bin/bash
echo ""
echo "=== Mobile Development Environment ==="
echo "✅ All mobile development checks passed!"
echo ""
echo "Next steps:"
echo "  mise run appium-doctor  # Run full Appium diagnostics"
echo "  mise run appium-start   # Start Appium server"
'''

# =============================================================================
# MAINTENANCE TASKS
# =============================================================================

[tasks.update]
description = "Update all tools"
depends = ["update-brew", "update-mise"]
run = "echo '✅ Updates complete!'"

[tasks.update-brew]
description = "Update Homebrew packages"
run = "brew update && brew upgrade"

[tasks.update-mise]
description = "Update mise and tools"
run = "mise self-update && mise upgrade"

[tasks.backup-brew]
description = "Backup Brewfile"
run = "brew bundle dump --force --file=$HOME/.dotfiles/brew/Brewfile && echo '✅ Brewfile updated'"
